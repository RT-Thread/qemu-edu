#
# Copyright (c) 2025, RT-Thread Development Team
#
# SPDX-License-Identifier: Apache-2.0
#

name: BSP Build Check

# Controls when the action will run
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'machines/**'
      - 'rt-thread'
      - '.github/workflows/bsp_build.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'machines/**'
      - 'rt-thread'
      - '.github/workflows/bsp_build.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04
    name: Build ${{ matrix.bsp }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - bsp: qemu-virt-riscv64
            toolchain: riscv64-unknown-elf
            toolchain_url: https://github.com/RT-Thread/toolchains-ci/releases/download/v1.4/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14.tar.gz
            toolchain_path: /opt/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14

          - bsp: qemu-vexpress-a9
            toolchain: arm-none-eabi
            apt_install: gcc-arm-none-eabi

          - bsp: qemu-virt-aarch64
            toolchain: aarch64-none-elf
            toolchain_url: https://github.com/RT-Thread/toolchains-ci/releases/download/v1.6/gcc-arm-10.2-2020.11-x86_64-aarch64-none-elf.tar.xz
            toolchain_path: /opt/gcc-arm-10.2-2020.11-x86_64-aarch64-none-elf

          - bsp: stm32f407-rt-spark
            toolchain: arm-none-eabi
            apt_install: gcc-arm-none-eabi

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install scons
        run: |
          python -m pip install --upgrade pip
          pip install scons

      - name: Install toolchain (apt)
        if: matrix.apt_install
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.apt_install }}

      - name: Cache toolchain
        if: matrix.toolchain_url
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: ${{ matrix.toolchain_path }}
          key: ${{ runner.os }}-${{ matrix.toolchain }}-${{ matrix.toolchain_url }}

      - name: Download and install toolchain
        if: matrix.toolchain_url && steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          wget -q ${{ matrix.toolchain_url }}
          filename=$(basename ${{ matrix.toolchain_url }})
          if [[ $filename == *.tar.gz ]]; then
            sudo tar -xzf $filename -C /opt
          elif [[ $filename == *.tar.xz ]]; then
            sudo tar -xf $filename -C /opt
          elif [[ $filename == *.tar.bz2 ]]; then
            sudo tar -xjf $filename -C /opt
          fi

      - name: Verify toolchain
        run: |
          if [ -n "${{ matrix.toolchain_path }}" ]; then
            export RTT_EXEC_PATH=${{ matrix.toolchain_path }}/bin
            $RTT_EXEC_PATH/${{ matrix.toolchain }}-gcc --version
          else
            ${{ matrix.toolchain }}-gcc --version
          fi

      - name: Build BSP
        run: |
          cd machines/${{ matrix.bsp }}
          if [ -n "${{ matrix.toolchain_path }}" ]; then
            export RTT_EXEC_PATH=${{ matrix.toolchain_path }}/bin
          fi
          scons -j$(nproc)

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.bsp }}-build
          path: |
            machines/${{ matrix.bsp }}/rtthread.bin
            machines/${{ matrix.bsp }}/rtthread.elf
            machines/${{ matrix.bsp }}/rt-thread.elf
            machines/${{ matrix.bsp }}/rtthread.hex
          if-no-files-found: ignore
